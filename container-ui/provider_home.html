<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>All Requests</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Bootstrap libraries -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' rel='stylesheet'
        integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC' crossorigin='anonymous'>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    <!-- Vue 3: production version, optimized for size and speed -->
    <!-- <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.prod.js'></script> -->
    <style>

        .modal-dialog {
        height: 80% !important;
        padding-top:10%;
        }

        .modal-content {
        height: 100% !important;
        overflow:visible;
        }

        .modal-body {
        height: 80%;
        overflow: auto;
        }

        .card{
            margin-top:20%;
        }

    </style>
</head>

<body>

    <body>
        <div id="main-container" class="container">
            <h1 class="display-4">Request Listings Near You</h1>
            <div id="request-results" class="row">
    
            </div>
        </div>
        <!-- Bootstrap Javascript; at the end of the <body> -->
        <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
            integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
            crossorigin='anonymous'></script>

        <script>
            // Helper function to display error message
            const get_all_request_URL = "http://127.0.0.1:5003/search_request/31"
            const accept_request_URL = "http://127.0.0.1:5009/accept_request"
            function showError(message) {
                // Hide the table and button in the event of error
                $('#requestTable').hide();
                $('#addRequestBtn').hide();

                // Display an error under the main container
                $('#main-container')
                    .append("<label>" + message + "</label>");
            }

            function accept_request(request_id, provider_id) {
                $(async() => {
                    var accept_request_URL = `http://127.0.0.1:5009/accept_request/${request_id}`

                    try {
                        const response = 
                            await fetch(
                                accept_request_URL, 
                                {
                                    method: 'POST',
                                    headers: {
                                        "Content-Type": "application/json"}, 
                                        body: JSON.stringify(
                                            {"request_id": request_id, 
                                            "provider_id": provider_id}
                                            )
                                        })
                    }
                    catch (error) {
                        console.log("Problem in placing an order." + error)
                    }
                })}


            // anonymous async function 
            // - using await requires the function that calls it to be async
            $(async () => {
                // Change serviceURL to your own
                var serviceURL = "http://0.0.0.0:5003/get_all_request";

                try {
                    console.log('2')
                    const response =
                        await fetch(
                            serviceURL, { method: 'GET' }
                        );
                    const result = await response.json();
                    // console.log(result)
                    if (response.status === 200) {
                        // success case
                        var requests = result.data.request; //the array is in books within data of the returned result
                        sessionStorage.setItem("hello", "bye")
                        // // for loop to setup all table rows with obtained book data

                        // TODO: find a way to put in provider_id into the function
                        for (const request of requests) {
                            html = `
                            <div class="col d-flex justify-content-around mt-2" id=${request.request_id} value=${request.request_id}>
                            <div class="card" style="width: 18rem;>
                                <div class="card-body ms-3">
                                    <h5 class="card-title ms-2">Request Number ${request.request_id}</h5>
                                    <h5 class="card-title ms-2 text-success">Request ${request.status}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted ms-2">${request.location_name}</h6>
                                    <span class="card-text ms-2" style="text-align:center;">${request.comments}</span>
                                    <a href="#" class="btn btn-success" onclick="accept_request(${request.request_id},1)">Accept Request</a>


                                    <!-- Button trigger modal -->
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                    Details
                                    </button>

                                    <!-- Modal -->
                                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <span class="card-text ms-2">Color: ${request.color}</span>
                                            <span class="card-text ms-2">Copies: ${request.no_of_copies}</span>
                                            <span class="card-text ms-2">Size: ${request.size}</span>
                                            <span class="card-text ms-2">Side: ${request.single_or_double}</span>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button href="#" type="button" onclick="accept_request(${request.request_id},1)" class="btn btn-primary">Accept Request!</button>
                                        </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                </div>`
                            document.getElementById("request-results").innerHTML += html
                        }
                        // add all the rows to the table
                        // $('#requestTable').append(rows);
                    } else if (response.status == 404) {
                        // No books
                        showError(result.message);
                    } else {
                        // unexpected outcome, throw the error
                        throw response.status;
                    }
                } catch (error) {
                    // Errors when calling the service; such as network error, 
                    // service offline, etc
                    showError('There is a problem retrieving requests, please try again later.<br />' + error);
                } // error
            });
        </script>

    </body>

</html>